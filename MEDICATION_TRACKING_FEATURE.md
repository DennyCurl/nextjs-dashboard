# üè• –û–±–ª—ñ–∫ –≤–∏–¥–∞–Ω–∏—Ö –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ñ–≤ - –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –ø–æ–¥–≤—ñ–π–Ω–æ—ó –≤–∏–¥–∞—á—ñ

## üö® –ü—Ä–æ–±–ª–µ–º–∞ —è–∫—É –≤–∏—Ä—ñ—à–∏–ª–∏

**–î–æ –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è:** –°–∏—Å—Ç–µ–º–∞ –¥–æ–∑–≤–æ–ª—è–ª–∞ –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ –≤–∏–¥–∞–≤–∞—Ç–∏ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–∏ –ø–æ –æ–¥–Ω–æ–º—É –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—é. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ –ø–∞—Ü—ñ—î–Ω—Ç—É –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ "–ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª –Ω–∞ 10 –¥–Ω—ñ–≤", –ª—ñ–∫–∞—Ä –º—ñ–≥:
- 1-–π –≤—ñ–∑–∏—Ç: –≤–∏–¥–∞—Ç–∏ –Ω–∞ 10 –¥–Ω—ñ–≤
- 2-–π –≤—ñ–∑–∏—Ç: –∑–Ω–æ–≤—É –≤–∏–¥–∞—Ç–∏ –Ω–∞ 10 –¥–Ω—ñ–≤  
- 3-–π –≤—ñ–∑–∏—Ç: —â–µ —Ä–∞–∑ –≤–∏–¥–∞—Ç–∏ –Ω–∞ 10 –¥–Ω—ñ–≤
- –Ü —Ç–∞–∫ –¥–∞–ª—ñ...

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–∞—Ü—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º—É–≤–∞–≤ –Ω–∞–±–∞–≥–∞—Ç–æ –±—ñ–ª—å—à–µ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ñ–≤ –Ω—ñ–∂ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ.

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è

–¢–µ–ø–µ—Ä —Å–∏—Å—Ç–µ–º–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥—Å—Ç–µ–∂—É—î** –≤–∂–µ –≤–∏–¥–∞–Ω—ñ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–∏ —ñ –ø–æ–∫–∞–∑—É—î —Ç—ñ–ª—å–∫–∏ –∑–∞–ª–∏—à–æ–∫.

### üîç –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:

1. **–ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω—å** —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î:
   - –°–∫—ñ–ª—å–∫–∏ –¥–Ω—ñ–≤ –±—É–ª–æ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ (`duration_days`)
   - –°–∫—ñ–ª—å–∫–∏ –≤–∂–µ –≤–∏–¥–∞–Ω–æ (`total_dispensed_days`)
   - –°–∫—ñ–ª—å–∫–∏ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è (`remaining_days`)

2. **–£ —Ñ–æ—Ä–º—ñ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–≥–ª—è–¥—É** –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∏ –∑ `remaining_days > 0`

3. **–ü—Ä–∏ –≤–∏–¥–∞—á—ñ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ñ–≤** —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å—É—î –≤ `drug_administrations` —ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º–µ–Ω—à—É—î –∑–∞–ª–∏—à–æ–∫

## üõ† –¢–µ—Ö–Ω—ñ—á–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è

### –ú–æ–¥–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ API `/api/prescriptions`

**–ù–æ–≤–∏–π SQL –∑–∞–ø–∏—Ç:**
```sql
SELECT 
  p.*, 
  db.full_drug_name, 
  db.unit, 
  am.quantity AS available_quantity,
  -- –°—É–º–∞ –≤–∂–µ –≤–∏–¥–∞–Ω–∏—Ö –¥–Ω—ñ–≤
  COALESCE(SUM(da.duration_days), 0) AS total_dispensed_days,
  -- –ó–∞–ª–∏—à–æ–∫ –¥–Ω—ñ–≤ –¥–ª—è –≤–∏–¥–∞—á—ñ
  GREATEST(0, p.duration_days - COALESCE(SUM(da.duration_days), 0)) AS remaining_days
FROM prescriptions p
LEFT JOIN drug_administrations da ON (
  da.id_drug = p.medication_id 
  AND da.id_prescription = p.prescription_number
  AND da.id_visit IN (SELECT v.id FROM visits v WHERE v.patient_id = ?)
)
GROUP BY p.id, ...
```

### –ú–æ–¥–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥

**–õ–æ–≥—ñ–∫–∞ —É `create-form.tsx`:**
```typescript
// –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ remaining_days –∑–∞–º—ñ—Å—Ç—å duration_days
let daysToShow = r.remaining_days ?? 0;

// –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –¥–µ –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–∞–ª–∏—à–∏–ª–æ—Å—å
if (daysToShow <= 0) continue;

// –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤–∂–µ –≤–∏–¥–∞–Ω—ñ –¥–Ω—ñ
const labelText = r.full_drug_name ?? `–ü—Ä–µ–ø–∞—Ä–∞—Ç ${r.medication_id}`;
const dispensedInfo = r.total_dispensed_days > 0 
  ? ` (–≤–∏–¥–∞–Ω–æ: ${r.total_dispensed_days} –¥–Ω—ñ–≤)`
  : '';

label: `${labelText}${dispensedInfo}`,
days: daysToShow, // –¢—ñ–ª—å–∫–∏ –∑–∞–ª–∏—à–æ–∫!
```

## üìä –ü—Ä–∏–∫–ª–∞–¥ —Ä–æ–±–æ—Ç–∏ —Å–∏—Å—Ç–µ–º–∏

### –°—Ü–µ–Ω–∞—Ä—ñ–π: "–ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –Ω–∞ 10 –¥–Ω—ñ–≤"

| –í—ñ–∑–∏—Ç | –î—ñ—è | –í–∏–¥–∞–Ω–æ –¥–Ω—ñ–≤ | –ó–∞–ª–∏—à–æ–∫ | –©–æ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –≤ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –≤—ñ–∑–∏—Ç—ñ |
|-------|-----|-------------|---------|-----------------------------------|
| 1 | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è | 0 | 10 | "–ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª" - 10 –¥–Ω—ñ–≤ |
| 2 | –í–∏–¥–∞—á–∞ | 3 | 7 | "–ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª (–≤–∏–¥–∞–Ω–æ: 3 –¥–Ω—ñ)" - 7 –¥–Ω—ñ–≤ |
| 3 | –í–∏–¥–∞—á–∞ | 5 | 2 | "–ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª (–≤–∏–¥–∞–Ω–æ: 8 –¥–Ω—ñ–≤)" - 2 –¥–Ω—ñ |
| 4 | –í–∏–¥–∞—á–∞ | 2 | 0 | –ü—Ä–µ–ø–∞—Ä–∞—Ç –ù–ï –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è (–ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–Ω–∏–π) |
| 5 | –°–ø—Ä–æ–±–∞ –≤–∏–¥–∞—á—ñ | - | 0 | –ü—Ä–µ–ø–∞—Ä–∞—Ç –ù–ï –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è |

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —Ñ–∞–π–ª `/test-medication-tracking.html`:

```bash
# –í—ñ–¥–∫—Ä–∏–π—Ç–µ —É –±—Ä–∞—É–∑–µ—Ä—ñ
http://localhost:3001/test-medication-tracking.html
```

### –†—É—á–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

1. **–°—Ç–≤–æ—Ä—ñ—Ç—å –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è** (–∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —ñ—Å–Ω—É—é—á–µ)
2. **–ü–µ—Ä—à–∏–π –≤—ñ–∑–∏—Ç:** –í–∏–¥–∞–π—Ç–µ —á–∞—Å—Ç–∏–Ω—É –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ñ–≤
3. **–î—Ä—É–≥–∏–π –≤—ñ–∑–∏—Ç:** –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –∑–∞–ª–∏—à–æ–∫
4. **–¢—Ä–µ—Ç—ñ–π –≤—ñ–∑–∏—Ç:** –í–∏–¥–∞–π—Ç–µ –≤–µ—Å—å –∑–∞–ª–∏—à–æ–∫
5. **–ß–µ—Ç–≤–µ—Ä—Ç–∏–π –≤—ñ–∑–∏—Ç:** –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å —â–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç –Ω–µ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è

## üîß API –∑–º—ñ–Ω–∏

### –ù–æ–≤—ñ –ø–æ–ª—è —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ `/api/prescriptions`

```json
{
  "medication_id": 42,
  "duration_days": 10,
  "prescription_number": "RX-123",
  "full_drug_name": "–ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª 500–º–≥",
  
  // –ù–û–í–Ü –ü–û–õ–Ø:
  "total_dispensed_days": 3,    // –°—É–º–∞ –≤–∂–µ –≤–∏–¥–∞–Ω–∏—Ö –¥–Ω—ñ–≤
  "remaining_days": 7           // –ó–∞–ª–∏—à–æ–∫ –¥–ª—è –≤–∏–¥–∞—á—ñ
}
```

### –õ–æ–≥—ñ–∫–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—ñ

- **–†–∞–Ω—ñ—à–µ:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤—Å—è `duration_days`
- **–¢–µ–ø–µ—Ä:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `remaining_days`
- **–§—ñ–ª—å—Ç—Ä:** –ü–æ–∫–∞–∑—É—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∏ –∑ `remaining_days > 0`

## üìÅ –ó–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏

- `app/api/prescriptions/route.ts` - –¥–æ–¥–∞–Ω–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–ª–∏—à–∫—ñ–≤
- `app/ui/visits/create-form.tsx` - –ª–æ–≥—ñ–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∑–∞–ª–∏—à–∫—ñ–≤  
- `public/test-medication-tracking.html` - —Ç–µ—Å—Ç–æ–≤–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞
- `MEDICATION_TRACKING_FEATURE.md` - —Ü—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ù–µ–º–æ–∂–ª–∏–≤–æ** –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ –≤–∏–¥–∞–≤–∞—Ç–∏ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–∏ –ø–æ –æ–¥–Ω–æ–º—É –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—é  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π** –æ–±–ª—ñ–∫ –≤–∂–µ –≤–∏–¥–∞–Ω–∏—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç—ñ–≤  
‚úÖ **–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å** - –ª—ñ–∫–∞—Ä –±–∞—á–∏—Ç—å —Å–∫—ñ–ª—å–∫–∏ –≤–∂–µ –±—É–ª–æ –≤–∏–¥–∞–Ω–æ  
‚úÖ **–¢–æ—á–Ω—ñ—Å—Ç—å** - –ø–∞—Ü—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º—É—î —Ä—ñ–≤–Ω–æ —Å—Ç—ñ–ª—å–∫–∏, —Å–∫—ñ–ª—å–∫–∏ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ  

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä –ø–æ–≤–Ω—ñ—Å—Ç—é –∫–æ–Ω—Ç—Ä–æ–ª—é—î –≤–∏–¥–∞—á—É –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ñ–≤ —ñ –∑–∞–ø–æ–±—ñ–≥–∞—î –ø–µ—Ä–µ–¥–æ–∑—É–≤–∞–Ω–Ω—é! üöÄ