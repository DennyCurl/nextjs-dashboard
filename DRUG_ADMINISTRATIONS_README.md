# Drug Administrations - Облік видачі медикаментів

## Опис

Система інтегрована з таблицею `pharmacy.administrations` для автоматичного збереження інформації про видані медикаменти пацієнтам під час медичних візитів.

## Структура таблиці `pharmacy.administrations`

```sql
CREATE TABLE pharmacy.administrations (
  id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_drug bigint NULL,                    -- Посилання на pharmacy.base.id
  id_visit bigint NULL,                   -- Посилання на visits.id
  id_prescription text NULL,              -- Номер рецепта
  dose real NULL,                         -- Доза препарату
  frequency_per_day real NULL,            -- Кількість прийомів на день
  duration_days real NULL,                -- Тривалість лікування в днях
  CONSTRAINT administrations_pkey PRIMARY KEY (id),
  CONSTRAINT administrations_id_drug_fkey FOREIGN KEY (id_drug) REFERENCES pharmacy.base (id) ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT administrations_id_visit_fkey FOREIGN KEY (id_visit) REFERENCES visits (id) ON UPDATE CASCADE ON DELETE CASCADE
);
```

## Як це працює

### 1. Створення огляду пацієнта

Коли лікар створює новий огляд через форму `/dashboard/visits/create`:

1. **Вибір медикаментів**: Лікар вибирає необхідні препарати з довідника
2. **Вказання дозування**: Для кожного препарату вказується:
   - Доза (наприклад, "500 мг")
   - Частота прийому на день (наприклад, 3 рази)
   - Тривалість лікування в днях (наприклад, 7 днів)
   - Номер рецепта (опціонально)
   - Примітка (опціонально)

### 2. Збереження даних

При відправці форми:

1. **JSON серіалізація**: Дані про медикаменти серіалізуються в JSON
2. **Валідація**: Система перевіряє коректність даних через Zod схему
3. **Транзакція БД**: В рамках однієї транзакції створюється:
   - Запис візиту (`visits`)
   - Запис огляду (`examinations`)
   - Записи діагнозів (`diagnosis`)
   - **Записи видачі медикаментів (`pharmacy.administrations`)**
   - Записи консультацій (`consultations`)
   - Записи лікарняних (`sick_leave`)

### 3. Обробка дози

Система автоматично:
- Парсить дозу з рядка в число (наприклад, "500 мг" → 500.0)
- Зберігає null якщо доза не вказана або некоректна
- Зберігає частоту та тривалість як числові значення

## API для отримання даних

### Всі видачі медикаментів (останні 100)
```
GET /api/drug-administrations
```

### Видачі для конкретного візиту
```
GET /api/drug-administrations?visitId=123
```

### Видачі для конкретного пацієнта
```
GET /api/drug-administrations?patientId=456
```

### Приклад відповіді:
```json
[
  {
    "id": 1,
    "id_drug": 42,
    "id_visit": 123,
    "id_prescription": "RX-001",
    "dose": 500,
    "frequency_per_day": 3,
    "duration_days": 7,
    "drug_name": "Парацетамол таблетки 500 мг",
    "unit": "таб",
    "patient_name": "Іванов Іван Іванович",
    "visit_date": "2025-11-05T10:30:00.000Z"
  }
]
```

## Тестування

### 1. Тестова сторінка
Відкрийте `/test-drug-administrations.html` для тестування API

### 2. Створення тестового огляду
1. Перейдіть на `/dashboard/visits/create`
2. Оберіть пацієнта
3. Додайте медикаменти з дозуванням
4. Створіть огляд
5. Перевірте збережені дані через API

## Код

### Валідація (actions.ts)
```typescript
const SelectedMedicationSchema = z.object({
  id: z.number().nullable().optional(),
  dose: z.string().nullable().optional(),
  frequencyPerDay: z.number().nullable().optional(),
  days: z.number().nullable().optional(),
  prescriptionNumber: z.string().nullable().optional(),
});
```

### Збереження (actions.ts)
```typescript
// insert drug administrations (medications) for this visit
if (medications && medications.length > 0) {
  for (const m of medications) {
    // Parse dose as real number if provided
    let doseValue: number | null = null;
    if (m.dose) {
      const parsed = parseFloat(m.dose);
      if (!isNaN(parsed)) {
        doseValue = parsed;
      }
    }

    await tx`
      INSERT INTO pharmacy.administrations (id_drug, id_visit, id_prescription, dose, frequency_per_day, duration_days)
      VALUES (${m.id ?? null}, ${visitId}, ${m.prescriptionNumber ?? null}, ${doseValue}, ${m.frequencyPerDay ?? null}, ${m.days ?? null})
    `;
  }
}
```

## Особливості реалізації

1. **Транзакційність**: Всі операції виконуються в рамках однієї транзакції
2. **Валідація**: Використання Zod для валідації вхідних даних
3. **Типізація**: Повна типізація TypeScript
4. **Обробка помилок**: Graceful handling помилок з retry логікою
5. **Оптимізація**: Індекси для швидкого пошуку
6. **Гнучкість**: Підтримка різних типів запитів через API

Система готова до використання і автоматично інтегрується з існуючим потоком створення медичних оглядів.