# üîß –í–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º–∏ "duplicate key value violates unique constraint visits_pkey"

## üö® –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –Ω–æ–≤–æ–≥–æ –æ–≥–ª—è–¥—É –≤–∏–Ω–∏–∫–∞—î –ø–æ–º–∏–ª–∫–∞:
```
duplicate key value violates unique constraint "visits_pkey"
Detail: Key (id)=(4) already exists.
```

## üîç –ü—Ä–∏—á–∏–Ω–∞
–ü—Ä–æ–±–ª–µ–º–∞ –≤–∏–Ω–∏–∫–∞—î —á–µ—Ä–µ–∑ –¥–µ—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ (sequence) PostgreSQL –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ `visits`. –¶–µ –º–æ–∂–µ —Å—Ç–∞—Ç–∏—Å—è –∫–æ–ª–∏:
- –î–∞–Ω—ñ –±—É–ª–∏ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω—ñ –∑ —è–≤–Ω–∏–º –≤–∫–∞–∑—É–≤–∞–Ω–Ω—è–º ID
- –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –±—É–ª–∞ –≤—Ä—É—á–Ω—É –∑–º—ñ–Ω–µ–Ω–∞
- –í–∏–Ω–∏–∫–ª–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –ø—Ä–∏ –≤—Å—Ç–∞–≤—Ü—ñ –¥–∞–Ω–∏—Ö

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
–ö–æ–¥ —Ç–µ–ø–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–ø—Ä–æ–±—É—î –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –ø—Ä–∏ –≤–∏–Ω–∏–∫–Ω–µ–Ω–Ω—ñ —Ü—ñ—î—ó –ø–æ–º–∏–ª–∫–∏.

### –í–∞—Ä—ñ–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ API
1. –ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä: `npm run dev`
2. –í–∏–∫–ª–∏—á—Ç–µ API: `curl -X POST http://localhost:3001/api/fix-visits-sequence`
3. –ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç: `./fix-sequence.sh`

### –í–∞—Ä—ñ–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ SQL (–ø—Ä—è–º–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –ë–î)
–Ø–∫—â–æ —É –≤–∞—Å —î –¥–æ—Å—Ç—É–ø –¥–æ PostgreSQL, –∑–∞–ø—É—Å—Ç—ñ—Ç—å:
```sql
SELECT setval('visits_id_seq', (SELECT COALESCE(MAX(id), 0) + 1 FROM visits), false);
```

–ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —Ñ–∞–π–ª `fix-visits-sequence.sql`

### –í–∞—Ä—ñ–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ psql command line
```bash
psql "$POSTGRES_URL" -c "SELECT setval('visits_id_seq', (SELECT COALESCE(MAX(id), 0) + 1 FROM visits), false);"
```

## üõ† –©–æ –±—É–ª–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–¥—ñ

### 1. –ó–º—ñ–Ω–µ–Ω–æ INSERT –∑–∞–ø–∏—Ç
**–ë—É–ª–æ:**
```sql
INSERT INTO visits (id, patient_id, user_id)
VALUES (DEFAULT, ${patientId}, ${userId})
```

**–°—Ç–∞–ª–æ:**
```sql
INSERT INTO visits (patient_id, user_id)  
VALUES (${patientId}, ${userId})
```

### 2. –î–æ–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
–ü—Ä–∏ –≤–∏–Ω–∏–∫–Ω–µ–Ω–Ω—ñ –ø–æ–º–∏–ª–∫–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –∫–ª—é—á–∞ –∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
1. –í–∏–∑–Ω–∞—á–∞—î –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π ID –≤ —Ç–∞–±–ª–∏—Ü—ñ
2. –°–∫–∏–¥–∞—î –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
3. –ü–æ–≤—Ç–æ—Ä—é—î –æ–ø–µ—Ä–∞—Ü—ñ—é –≤—Å—Ç–∞–≤–∫–∏

## üß™ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä—ñ—à–µ–Ω–Ω—è

1. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω:**
```sql
SELECT 'Max ID:' as info, MAX(id) FROM visits;
SELECT 'Sequence:' as info, last_value FROM visits_id_seq;
```

2. **–°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –æ–≥–ª—è–¥** —á–µ—Ä–µ–∑ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å

3. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ –≤—Å–µ –ø—Ä–∞—Ü—é—î:**
- –û–≥–ª—è–¥ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –±–µ–∑ –ø–æ–º–∏–ª–æ–∫
- ID –∞–≤—Ç–æ—ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

## üìã –§–∞–π–ª–∏ —è–∫—ñ –±—É–ª–æ –∑–º—ñ–Ω–µ–Ω–æ:
- `app/lib/actions.ts` - –¥–æ–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ
- `app/api/fix-visits-sequence/route.ts` - API –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
- `fix-sequence.sh` - —Å–∫—Ä–∏–ø—Ç –¥–ª—è –≤–∏–∫–ª–∏–∫—É API
- `fix-visits-sequence.sql` - SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä—è–º–æ–≥–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

–¢–µ–ø–µ—Ä —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏—Ä—ñ—à—É–≤–∞—Ç–∏–º–µ —Ü—é –ø—Ä–æ–±–ª–µ–º—É –ø—Ä–∏ —ó—ó –≤–∏–Ω–∏–∫–Ω–µ–Ω–Ω—ñ!