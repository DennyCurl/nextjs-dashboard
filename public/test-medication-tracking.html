<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –æ–±–ª—ñ–∫—É –≤–∏–¥–∞–Ω–∏—Ö –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ñ–≤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
        }

        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }

        .result {
            background: #e8f5e8;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #4caf50;
            max-height: 500px;
            overflow-y: auto;
        }

        .error {
            background: #ffe8e8;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ff4444;
        }

        .api-url {
            background: #f0f0f0;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }

        button {
            background: #007acc;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #005a9e;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .input-group {
            margin: 10px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        .highlight {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>üß™ –¢–µ—Å—Ç –æ–±–ª—ñ–∫—É –≤–∏–¥–∞–Ω–∏—Ö –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ñ–≤</h1>

    <div class="test-section">
        <h2>üìã –û–ø–∏—Å —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ</h2>
        <p>–¢–µ–ø–µ—Ä —Å–∏—Å—Ç–µ–º–∞ –≤—Ä–∞—Ö–æ–≤—É—î –≤–∂–µ –≤–∏–¥–∞–Ω—ñ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–∏ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω—å:</p>
        <ul>
            <li>üîç –†–æ–∑—Ä–∞—Ö–æ–≤—É—î —Å—É–º—É –≤–∂–µ –≤–∏–¥–∞–Ω–∏—Ö –¥–Ω—ñ–≤ –∑ —Ç–∞–±–ª–∏—Ü—ñ drug_administrations</li>
            <li>üìä –ü–æ–∫–∞–∑—É—î —Ç—ñ–ª—å–∫–∏ –∑–∞–ª–∏—à–æ–∫ –¥–Ω—ñ–≤, —â–æ —â–µ –Ω–µ –±—É–≤ –≤–∏–¥–∞–Ω–∏–π</li>
            <li>‚ö†Ô∏è –ù–µ –¥–æ–∑–≤–æ–ª—è—î –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ –≤–∏–¥–∞–≤–∞—Ç–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∏ –ø–æ –æ–¥–Ω–æ–º—É –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—é</li>
            <li>üìù –ü–æ–∫–∞–∑—É—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤–∂–µ –≤–∏–¥–∞–Ω—ñ –¥–Ω—ñ –≤ –Ω–∞–∑–≤—ñ –ø—Ä–µ–ø–∞—Ä–∞—Ç—É</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>1. –¢–µ—Å—Ç API –ø—Ä–∏–∑–Ω–∞—á–µ–Ω—å –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –≤–∏–¥–∞—á</h2>
        <div class="input-group">
            <label for="patientId">ID –ø–∞—Ü—ñ—î–Ω—Ç–∞:</label>
            <input type="number" id="patientId" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 1" value="1" />
        </div>
        <div class="api-url">GET /api/prescriptions?patientId={patientId}</div>
        <button onclick="testPrescriptionsAPI()">–¢–µ—Å—Ç—É–≤–∞—Ç–∏ API –ø—Ä–∏–∑–Ω–∞—á–µ–Ω—å</button>

        <div class="highlight">
            <strong>–û—á—ñ–∫—É–≤–∞–Ω—ñ –ø–æ–ª—è —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:</strong>
            <ul>
                <li><code>total_dispensed_days</code> - —Å—É–º–∞ –≤–∂–µ –≤–∏–¥–∞–Ω–∏—Ö –¥–Ω—ñ–≤</li>
                <li><code>remaining_days</code> - –¥–Ω—ñ —â–æ –∑–∞–ª–∏—à–∏–ª–∏—Å—å –¥–ª—è –≤–∏–¥–∞—á—ñ</li>
            </ul>
        </div>

        <div id="prescriptions-result" class="result" style="display: none;">
            <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç API –ø—Ä–∏–∑–Ω–∞—á–µ–Ω—å:</h4>
            <pre id="prescriptions-data"></pre>
        </div>
    </div>

    <div class="test-section">
        <h2>2. –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –≤–∏–¥–∞—á–∞–º–∏ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ñ–≤</h2>
        <div class="input-group">
            <label for="patientId2">ID –ø–∞—Ü—ñ—î–Ω—Ç–∞:</label>
            <input type="number" id="patientId2" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 1" value="1" />
        </div>
        <div class="api-url">GET /api/drug-administrations?patientId={patientId}</div>
        <button onclick="testAdministrationsAPI()">–¢–µ—Å—Ç—É–≤–∞—Ç–∏ API –≤–∏–¥–∞—á</button>

        <div id="administrations-result" class="result" style="display: none;">
            <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç API –≤–∏–¥–∞—á:</h4>
            <pre id="administrations-data"></pre>
        </div>
    </div>

    <div class="test-section">
        <h2>3. –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è</h2>
        <ol>
            <li>–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π (<code>npm run dev</code>)</li>
            <li>–í–∏–±–µ—Ä—ñ—Ç—å –ø–∞—Ü—ñ—î–Ω—Ç–∞, —É —è–∫–æ–≥–æ —î –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ñ–≤</li>
            <li>–ü–æ–¥–∏–≤—ñ—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è - —Å–∫—ñ–ª—å–∫–∏ –¥–Ω—ñ–≤ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ</li>
            <li>–°—Ç–≤–æ—Ä—ñ—Ç—å –æ–≥–ª—è–¥ —ñ –≤–∏–¥–∞–π—Ç–µ —á–∞—Å—Ç–∏–Ω—É –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 5 –¥–Ω—ñ–≤ –∑ 10)</li>
            <li>–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∑–Ω–æ–≤—É - –º–∞—î –ø–æ–∫–∞–∑–∞—Ç–∏ –∑–∞–ª–∏—à–æ–∫ (5 –¥–Ω—ñ–≤)</li>
            <li>–°–ø—Ä–æ–±—É–π—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —â–µ –æ–¥–∏–Ω –æ–≥–ª—è–¥ - –º–∞—î –ø–æ–∫–∞–∑–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –∑–∞–ª–∏—à–æ–∫</li>
        </ol>

        <button onclick="window.open('/dashboard/visits/create', '_blank')">
            –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ–æ—Ä–º—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–≥–ª—è–¥—É
        </button>
    </div>

    <div class="test-section">
        <h2>4. –ü—Ä–∏–∫–ª–∞–¥ –æ—á—ñ–∫—É–≤–∞–Ω–æ—ó –ø–æ–≤–µ–¥—ñ–Ω–∫–∏</h2>

        <div class="highlight">
            <h4>–°—Ü–µ–Ω–∞—Ä—ñ–π:</h4>
            <p>–ü–∞—Ü—ñ—î–Ω—Ç—É –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ "–ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª –Ω–∞ 10 –¥–Ω—ñ–≤"</p>
            <ol>
                <li><strong>–ü–µ—Ä—à–∏–π –æ–≥–ª—è–¥:</strong> –í–∏–¥–∞—î–º–æ –Ω–∞ 3 –¥–Ω—ñ ‚Üí –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è 7 –¥–Ω—ñ–≤</li>
                <li><strong>–î—Ä—É–≥–∏–π –æ–≥–ª—è–¥:</strong> –í–∏–¥–∞—î–º–æ –Ω–∞ 5 –¥–Ω—ñ–≤ ‚Üí –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è 2 –¥–Ω—ñ</li>
                <li><strong>–¢—Ä–µ—Ç—ñ–π –æ–≥–ª—è–¥:</strong> –í–∏–¥–∞—î–º–æ –Ω–∞ 2 –¥–Ω—ñ ‚Üí –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è 0 –¥–Ω—ñ–≤</li>
                <li><strong>–ß–µ—Ç–≤–µ—Ä—Ç–∏–π –æ–≥–ª—è–¥:</strong> –ü—Ä–µ–ø–∞—Ä–∞—Ç –Ω–µ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è (–ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–Ω–∏–π)</li>
            </ol>
        </div>
    </div>

    <script>
        async function testPrescriptionsAPI() {
            const patientId = document.getElementById('patientId').value;
            const resultDiv = document.getElementById('prescriptions-result');
            const dataDiv = document.getElementById('prescriptions-data');

            if (!patientId) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å ID –ø–∞—Ü—ñ—î–Ω—Ç–∞');
                return;
            }

            try {
                resultDiv.style.display = 'block';
                dataDiv.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';

                const response = await fetch(`/api/prescriptions?patientId=${patientId}`);
                const data = await response.json();

                if (response.ok) {
                    dataDiv.textContent = JSON.stringify(data, null, 2);
                    resultDiv.className = 'result';

                    // –ê–Ω–∞–ª—ñ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
                    const analysis = analyzeData(data, 'prescriptions');
                    if (analysis) {
                        dataDiv.textContent += '\n\n' + analysis;
                    }
                } else {
                    dataDiv.textContent = `–ü–æ–º–∏–ª–∫–∞: ${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'error';
                }
            } catch (error) {
                dataDiv.textContent = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
                resultDiv.className = 'error';
            }
        }

        async function testAdministrationsAPI() {
            const patientId = document.getElementById('patientId2').value;
            const resultDiv = document.getElementById('administrations-result');
            const dataDiv = document.getElementById('administrations-data');

            if (!patientId) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å ID –ø–∞—Ü—ñ—î–Ω—Ç–∞');
                return;
            }

            try {
                resultDiv.style.display = 'block';
                dataDiv.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';

                const response = await fetch(`/api/drug-administrations?patientId=${patientId}`);
                const data = await response.json();

                if (response.ok) {
                    dataDiv.textContent = JSON.stringify(data, null, 2);
                    resultDiv.className = 'result';

                    // –ê–Ω–∞–ª—ñ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
                    const analysis = analyzeData(data, 'administrations');
                    if (analysis) {
                        dataDiv.textContent += '\n\n' + analysis;
                    }
                } else {
                    dataDiv.textContent = `–ü–æ–º–∏–ª–∫–∞: ${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'error';
                }
            } catch (error) {
                dataDiv.textContent = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
                resultDiv.className = 'error';
            }
        }

        function analyzeData(data, type) {
            if (!Array.isArray(data) || data.length === 0) {
                return 'üìä –ê–ù–ê–õ–Ü–ó: –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É';
            }

            let analysis = 'üìä –ê–ù–ê–õ–Ü–ó –†–ï–ó–£–õ–¨–¢–ê–¢–Ü–í:\n';

            if (type === 'prescriptions') {
                analysis += `üìã –ó–Ω–∞–π–¥–µ–Ω–æ ${data.length} –ø—Ä–∏–∑–Ω–∞—á–µ–Ω—å\n`;

                data.forEach((item, index) => {
                    analysis += `\n${index + 1}. ${item.full_drug_name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –ø—Ä–µ–ø–∞—Ä–∞—Ç'}:\n`;
                    analysis += `   - –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –¥–Ω—ñ–≤: ${item.duration_days || 'N/A'}\n`;
                    analysis += `   - –í–∂–µ –≤–∏–¥–∞–Ω–æ: ${item.total_dispensed_days || 0} –¥–Ω—ñ–≤\n`;
                    analysis += `   - –ó–∞–ª–∏—à–∞—î—Ç—å—Å—è: ${item.remaining_days || 0} –¥–Ω—ñ–≤\n`;
                    analysis += `   - –†–µ—Ü–µ–ø—Ç ‚Ññ: ${item.prescription_number || 'N/A'}\n`;

                    if ((item.remaining_days || 0) <= 0) {
                        analysis += `   ‚ö†Ô∏è –£–í–ê–ì–ê: –ü—Ä–µ–ø–∞—Ä–∞—Ç –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–Ω–∏–π!\n`;
                    }
                });
            } else if (type === 'administrations') {
                analysis += `üíä –ó–Ω–∞–π–¥–µ–Ω–æ ${data.length} –≤–∏–¥–∞—á –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ñ–≤\n`;

                // –ì—Ä—É–ø—É—î–º–æ –ø–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞—Ö
                const byDrug = {};
                data.forEach(item => {
                    const key = item.drug_name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –ø—Ä–µ–ø–∞—Ä–∞—Ç';
                    if (!byDrug[key]) byDrug[key] = [];
                    byDrug[key].push(item);
                });

                Object.entries(byDrug).forEach(([drugName, administrations]) => {
                    const totalDays = administrations.reduce((sum, item) => sum + (item.duration_days || 0), 0);
                    analysis += `\nüì¶ ${drugName}:\n`;
                    analysis += `   - –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏–¥–∞—á: ${administrations.length}\n`;
                    analysis += `   - –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥–Ω—ñ–≤: ${totalDays}\n`;
                });
            }

            return analysis;
        }
    </script>
</body>

</html>